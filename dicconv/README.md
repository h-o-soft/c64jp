# 辞書変換ツール

| [English](README-en.md) | [日本語](README.md) |
|---------------------------|------------------------|

SKK形式の日本語辞書をC64漢字ROMカートリッジ用バイナリ形式に変換するツールです。

## 概要

SKK形式のテキスト辞書ファイルを、C64上で高速にアクセス可能なバイナリ形式に変換します。変換後の辞書はIME（日本語入力）機能で使用され、ひらがなから漢字への変換を実現します。

## 使用方法

### 基本的な使い方

```bash
# SKK辞書をバイナリ形式に変換
python3 dicconv.py skkdic.txt skkdic.bin

# 入力ファイルと出力ファイルを指定
python3 dicconv.py input_dictionary.txt output_dictionary.bin
```

### プロジェクトのMakefileから使用

```bash
# プロジェクトルートで実行
make dict  # 辞書を変換してCRTファイルを作成
```

## 辞書ファイル形式

### 入力形式（SKK辞書）

- **文字コード**: EUC-JP
- **形式**: SKK辞書形式
- **構造**: `よみ /候補1/候補2/.../候補n/`

#### 送りなしエントリ
読みがすべてひらがなで、送り仮名を含まないエントリ：
```
あい /愛/哀/相/藍/
かんじ /漢字/感じ/幹事/
へんかん /変換/返還/
```

#### 送りありエントリ
読みの末尾に送り仮名のローマ字を含むエントリ：
```
かk /書/描/
おくr /送/贈/
たべr /食べ/
はしr /走/
```

送り仮名の表記：
- `k` - か行（か、き、く、け、こ）
- `r` - ら行（ら、り、る、れ、ろ）
- `t` - た行（た、ち、つ、て、と）
- その他、活用に応じた子音を使用

### 出力形式（バイナリ辞書）

#### ヘッダー構造
```
+0x00: 'DIC' + 0x00 (4 bytes) - マジックナンバー
+0x04: 送りなしエントリオフセットテーブル (82エントリ × 3 bytes = 246 bytes)
+0xFA: 送りありエントリオフセットテーブル (82エントリ × 3 bytes = 246 bytes)
```

#### オフセットテーブル

各ひらがなの先頭文字（あ、い、う...）ごとにエントリの開始位置を記録：
- L (下位バイト): バンク内オフセット低位
- M (中位バイト): バンク内オフセット高位  
- H (上位バイト): バンク番号（8KBごと）

#### エントリ構造
```
+0: エントリサイズ (2 bytes, リトルエンディアン)
    - 先頭エントリの場合はMSBがセット（0x8000 OR）
+2: 読み文字列 (Shift-JIS, null終端)
+n: 候補数 (1 byte)
+n+1: 候補1 (Shift-JIS, null終端)
+n+m: 候補2 (Shift-JIS, null終端)
...
```

## 索引キー

辞書は82種類のひらがなで索引されます：

```
あ ぃ い ぅ う ぇ え ぉ お
か が き ぎ く ぐ け げ こ ご
さ ざ し じ す ず せ ぜ そ ぞ
た だ ち ぢ っ つ づ て で と ど
な に ぬ ね の
は ば ぱ ひ び ぴ ふ ぶ ぷ へ べ ぺ ほ ぼ ぽ
ま み む め も
ゃ や ゅ ゆ ょ よ
ら り る れ ろ
ゎ わ ゐ ゑ を ん
```

## 分類ルール

- **送りなしエントリ**: 読みの最後が全角文字（ひらがな・カタカナ・漢字）
- **送りありエントリ**: 読みの最後が半角文字（送り仮名を示すローマ字）

例：
- `あい` → 送りなしエントリ
- `かk` → 送りありエントリ（「書く」の活用、送り仮名「く」）
- `おくr` → 送りありエントリ（「送る」の活用、送り仮名「る」）

## ソート順序

各グループ内のエントリは以下の優先順位でソート：
1. 文字列長（長い順）- より具体的な変換を優先
2. 辞書順（あいうえお順）

## 技術仕様

### dicconv.py

主要なクラスと関数：

#### CharOffsetEntry
```python
@dataclass
class CharOffsetEntry:
    key: str          # 索引文字（あ、い、う...）
    offset: int       # データ開始オフセット
    header_size: int  # ヘッダーサイズ
    entry_size: int   # エントリ合計サイズ
    entries: list     # DicEntryのリスト
```

#### DicEntry
```python
@dataclass  
class DicEntry:
    all_size: int     # エントリ全体のサイズ
    key: str          # 読み（Shift-JIS）
    kouho_count: int  # 候補数
    kouho: list       # 候補リスト
```

### メモリ配置

C64のMagicDeskカートリッジ形式に合わせて8KBバンク単位で配置：
- バンク0: プログラムコード
- バンク1〜9: フォントデータ
- バンク10〜: 辞書データ

## ファイル構成

```
dicconv/
├── dicconv.py       # 辞書変換スクリプト
├── README.md        # このファイル
├── skkdic.txt       # 入力: SKK形式辞書（EUC-JP）
└── skkdic.bin       # 出力: バイナリ辞書
```

## 依存関係

- Python 3.x
- dataclasses（Python 3.7以降は標準ライブラリ）

## トラブルシューティング

### 文字コードエラー

入力ファイルがEUC-JPでない場合：
```bash
# UTF-8からEUC-JPに変換
iconv -f UTF-8 -t EUC-JP input.txt > output_eucjp.txt
```

### メモリ不足

大きな辞書ファイルの場合、変換後のサイズが大きくなる可能性があります：
- 不要なエントリを削除
- 候補数を制限
- 複数の辞書に分割

### 辞書が見つからない

IMEから辞書が見つからない場合：
- CRTファイルに辞書が含まれているか確認
- 辞書のバンク番号が正しいか確認

## 辞書データのライセンス

SKK辞書を使用する場合は、各辞書のライセンスに従ってください：

- **SKK-JISYO.L**: GPLv2+
- **SKK-JISYO.M**: GPLv2+
- **SKK-JISYO.S**: GPLv2+

独自の辞書を作成する場合は、SKK形式に従って作成してください。

## 関連ドキュメント

- [プロジェクトREADME](../README.md)
- [SKK OpenLab](https://skk-dev.github.io/dict/)
- [SKK辞書の書式](https://skk-dev.github.io/dict/format.html)