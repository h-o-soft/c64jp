# CRT Cartridge Creator

| [English](README-en.md) | [日本語](README.md) |
|---------------------------|------------------------|

Creates MagicDesk format CRT cartridge files for the C64 Kanji ROM system.

## Overview

This tool packages the Japanese font data, dictionary data, and string resources into a MagicDesk format cartridge file that can be used with Commodore 64 emulators or real hardware with compatible flash cartridges.

## Features

- **MagicDesk Format**: Creates Type 19 (MagicDesk) CRT files with 8KB bank switching
- **Multi-resource Support**: Combines fonts, dictionary, and string resources in a single cartridge
- **Automatic Assembly**: Assembles the boot code using 64tass
- **Flexible Layout**: Automatically arranges resources in optimal bank positions

## Files

| File | Description |
|------|-------------|
| `create_crt.py` | Main CRT creation script |
| `kanji-magicdesk-basic.asm` | Boot code source (64tass format) |
| `kanji-magicdesk-basic.bin` | Assembled boot code (generated) |

## Usage

### Basic Usage

```bash
# Create basic cartridge with fonts only
python create_crt.py

# Create cartridge with custom output name
python create_crt.py -o my_cartridge.crt

# Create cartridge with dictionary
python create_crt.py --dictionary-file ../dicconv/skkdicm.bin

# Create cartridge with string resources
python create_crt.py --string-resource-file ../stringresources/test_strings.txt
```

### Command Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `-o, --output` | Output CRT filename | `c64jpkanji.crt` |
| `--font-file` | Full-width font file path | `../fontconv/font_misaki_gothic.bin` |
| `--jisx0201-file` | Half-width font file path | `../fontconv/font_jisx0201.bin` |
| `--dictionary-file` | Dictionary file path | None (optional) |
| `--string-resource-file` | String resource file | None (optional) |

## Cartridge Structure

The MagicDesk cartridge is organized in 8KB banks:

### Bank Layout

| Bank | Contents | Size |
|------|----------|------|
| 0 | Boot code (kanji-magicdesk-basic) | 8KB |
| 1-9 | Font data (JIS X 0201 + JIS X 0208) | ~72KB |
| 10-35 | Dictionary data (if included) | ~208KB |
| 36+ | String resources (if included) | Variable |

### Memory Mapping

- **$8000-$9FFF**: 8KB bank window (ROML)
- **$DE00**: MagicDesk bank register

## Boot Code

The cartridge includes a minimal boot program (`kanji-magicdesk-basic.asm`) that:

1. Initializes the C64 hardware
2. Displays "C64 KANJI ROM SYSTEM" message
3. Waits approximately 1 second
4. Returns to BASIC

### Cartridge Header

The boot code contains the required CBM80 signature:
- **$8000-$8001**: Cold start vector
- **$8002-$8003**: Warm start vector  
- **$8004-$8008**: "CBM80" signature in PETSCII

## CRT File Format

The generated CRT file follows the standard VICE CRT format:

### CRT Header (64 bytes)
- Signature: "C64 CARTRIDGE   "
- Hardware Type: 19 (MagicDesk)
- EXROM: 0, GAME: 1 (16K configuration)
- Name: "KANJI ROM MD"

### CHIP Packets
Each 8KB bank is stored as a CHIP packet:
- CHIP signature
- Packet length
- Bank number
- Load address ($8000)
- Data (8192 bytes)

## Build Process

1. **Assemble Boot Code**: 64tass assembles `kanji-magicdesk-basic.asm` to binary
2. **Load Resources**: Reads font files, dictionary, and string resources
3. **Arrange Banks**: Places resources in sequential 8KB banks
4. **Create CRT**: Generates CRT header and CHIP packets
5. **Write File**: Outputs complete CRT file

## Requirements

- Python 3.x
- 64tass assembler (included with Prog8)
- Font files (generated by fontconv)
- Optional: Dictionary file (generated by dicconv)
- Optional: String resource files

## Integration with Main Build

This tool is typically called from the main Makefile:

```makefile
# Create basic CRT
make crt

# Create CRT with dictionary
make dict

# Create CRT with string resources
make TARGET=hello_resource run-strings
```

## Testing

Test the generated cartridge with VICE:

```bash
# Run in VICE emulator
x64sc -cartcrt c64jpkanji.crt

# With additional program
x64sc -cartcrt c64jpkanji.crt prog8/build/hello.prg
```

## Hardware Compatibility

The MagicDesk format is supported by:
- EasyFlash 3
- Ultimate 64 / 1541 Ultimate-II+
- Kung Fu Flash
- VICE emulator (x64sc)

## Troubleshooting

### Assembly Errors
If 64tass fails to assemble the boot code:
- Check that 64tass is in your PATH
- Verify the syntax in kanji-magicdesk-basic.asm
- Ensure the file exists and is readable

### File Not Found
If font or other resource files are not found:
- Run `make fonts` to generate font files
- Run `make dict` to generate dictionary file
- Check file paths in command line arguments

### Binary Size Warning
If you see warnings about binary size:
- The tool automatically pads or truncates to 8KB boundaries
- This is normal and doesn't affect functionality

### Cartridge Not Recognized
If the cartridge doesn't work:
- Verify the CRT file size is a multiple of 8KB + 64 bytes (header)
- Check that the boot code contains the CBM80 signature
- Ensure MagicDesk is supported by your hardware/emulator

## See Also

- [Main README](../README.md) - Project overview
- [fontconv](../fontconv/README.md) - Font conversion tools
- [dicconv](../dicconv/README.md) - Dictionary conversion
- [stringresources](../stringresources/README.md) - String resource management